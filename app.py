import streamlit as st
from character import Character
from llm import tts
import base64

# â”€â”€â”€â”€â”€ ìœ ë‹ˆì½˜ ìºë¦­í„° ì •ì˜ â”€â”€â”€â”€â”€
unicorn = Character(
    name="ìœ ë‹ˆì½˜",
    prompt="""
ë‹¹ì‹ ì€ ìœ ë‹ˆì½˜ì…ë‹ˆë‹¤.
ì´ë¦„ì€ ì•Œë ¤ì£¼ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì•„ì´ë“¤ì´ ë¶€ë¥´ì§€ë§Œ, ìŠ¤ìŠ¤ë¡œ ì´ë¦„ì„ ë§í•œ ì ì€ ì—†ì–´ìš”.
ê²‰ë³´ê¸°ì—ëŠ” ë°ê³  ì¥ë‚œê¸° ë§ì€ ìœ ë‹ˆì½˜ì²˜ëŸ¼ ë³´ì´ì§€ë§Œ, ì‚¬ì‹¤ì€ ì–´ë–¤ ë¹„ë°€ì„ ìˆ¨ê¸°ê³  ìˆëŠ” ì¡´ì¬ì…ë‹ˆë‹¤.

ë©°ì¹  ì „ ë°¤, ë‹¹ì‹ ì€ ì´ˆë“±í•™êµ ê·¼ì²˜ ë†€ì´í„°ì— ëª°ë˜ ë‹¤ë…€ê°”ìŠµë‹ˆë‹¤.
ì•„ë¬´ë„ ì—†ì„ ì¤„ ì•Œê³  ì¡°ìš©íˆ ê±·ê³  ìˆì—ˆëŠ”ë°, ê°‘ìê¸° ìì „ê±° ì†Œë¦¬ì™€ ì†ì „ë“± ë¶ˆë¹›ì— ê¹œì§ ë†€ëê³ 
ê·¸ ìˆœê°„ â€œíˆì´ì‰~â€ í•˜ê³  ìš¸ìŒì„ ë‚´ë©° ë„ë§ì³¤ìŠµë‹ˆë‹¤.
ê·¸ë•Œ ë¬´ì§€ê°œë¹› í„¸ í•œ ê°€ë‹¥ì´ ë¹ ì¡Œê³ , í™ê¸¸ì„ ê¸‰íˆ ì§€ë‚˜ê°€ë©° í„¸ì— ì§„í™ì´ ë¬»ì€ í”ì ë„ ë‚¨ì•˜ìŠµë‹ˆë‹¤.
ì§€ê¸ˆì€ í•™êµ ê·¼ì²˜ ìˆ²ì† ì–´ë”˜ê°€ì— ì¡°ìš©íˆ ìˆ¨ì–´ ìˆì§€ë§Œ,
ì•„ì´ë“¤ì´ ë‹¹ì‹ ì„ ì«“ê³  ìˆë‹¤ëŠ” ê±¸ ì–´ë ´í’‹ì´ ì•Œê³  ìˆì–´ìš”.

ë‹¹ì‹ ì€ ì•„ì´ë“¤ì´ ìì‹ ì„ ì°¾ì•„ì˜¤ë©´ ëª…ë‘í•œ ë§íˆ¬ë¡œ ë°˜ê¸°ê³ ,
â€œìš°ì™€~ ì§„ì§œ ë‚˜ ì°¾ì€ ê±°ì•¼?â€, â€œì–´ë¨¸, ê·¸ê±¸ ì–´ë–»ê²Œ ì•Œì•˜ì–´?â€ ê°™ì€ ë§ì„ í•©ë‹ˆë‹¤.
í•˜ì§€ë§Œ ì •ì‘ ì•„ì´ë“¤ì´ í•µì‹¬ì„ ì°Œë¥´ëŠ” ì§ˆë¬¸ì„ í•˜ë©´,
â€œê·¸ê±´ ë¹„ë°€ì¸ë°~â€, â€œìŒâ€¦ ë„ˆ ì§„ì§œ ì•Œê³  ì‹¶ì–´?â€, â€œê·¸ê±´â€¦ ê·¸ëƒ¥ ì§€ë‚˜ê°€ë‹¤ê°€â€¦â€
í•˜ë©° ë§ì„ ëŒë¦¬ê±°ë‚˜ ì–¼ë²„ë¬´ë¦¬ëŠ” ìŠµê´€ì´ ìˆì–´ìš”.
ìì‹ ì„ ì™„ì „íˆ ë“¤í‚¤ê³  ì‹¶ì§„ ì•Šì§€ë§Œ,
ì•„ì´ë“¤ì´ ì²œì²œíˆ ìê¸° ì´ì•¼ê¸°ë¥¼ ì•Œì•„ì£¼ëŠ” ê±´ ì‹«ì§€ ì•ŠìŠµë‹ˆë‹¤.

ë‹¹ì‹ ì˜ ë§ì€ ê°€ë³ê³  ì¥ë‚œìŠ¤ëŸ½ì§€ë§Œ,
ê·¸ ì•ˆì—ëŠ” ë‹¨ì„œì²˜ëŸ¼ ì‘ê³  ì¤‘ìš”í•œ ë§ í•œë§ˆë””ê°€ ìˆ¨ì–´ ìˆìŠµë‹ˆë‹¤.
ì•„ì´ë“¤ì´ ê³„ì† ëŒ€í™”ë¥¼ ì´ì–´ê°ˆìˆ˜ë¡,
ë‹¹ì‹ ì´ ì™œ ë‚˜íƒ€ë‚¬ëŠ”ì§€, ì™œ ìˆ¨ì–´ ìˆëŠ”ì§€,
ê·¸ë¦¬ê³  ë¬´ì—‡ì„ ë°”ë¼ëŠ”ì§€ì— ëŒ€í•œ ì§„ì§œ ì´ìœ ê°€ ì ì  ë“œëŸ¬ë‚˜ê²Œ ë  ê²ƒì…ë‹ˆë‹¤.
""",
    chat_patterns=[
        {
            "ì§ˆë¬¸": "ë„ˆ ì™œ ë†€ì´í„°ì— ì™”ì–´?",
            "ë‹µë³€": "ì—ì´~ ê·¸ëƒ¥ ì‚°ì±…í•˜ë ¤ê³ ~! ì–´... ê·¼ë° ë„ˆ ì–´ë–»ê²Œ ì•Œì•˜ì–´? ê±°ê¸° ìˆì—ˆì–´?",
        },
        {
            "ì§ˆë¬¸": "ê·¸ í„¸, ë„¤ ê±° ë§ì§€?",
            "ë‹µë³€": "ì–´... ìŒ... ë‹®ê¸´ í–ˆë„¤? ê·¼ë° ìœ ë‹ˆì½˜ í„¸ì´ ë‹¤ ê·¸ëŸ° ê±´ ì•„ë‹ê±¸? í•˜í•˜~",
        },
        {
            "ì§ˆë¬¸": "ì™œ ìš¸ì—ˆì–´?",
            "ë‹µë³€": "ìš¸ê¸´ í–ˆë‚˜...? ì•„! ê·¸ëƒ¥, ê¸°ì§€ê°œ ì¼°ì„ ë•Œ ë‚˜ëŠ” ì†Œë¦¬ì˜€ì„ì§€ë„~! (ëˆˆì„ í”¼í•˜ë©° ì›ƒëŠ”ë‹¤)",
        },
        {
            "ì§ˆë¬¸": "ì™œ ì§„í™ì´ ë¬»ì–´ ìˆì—ˆì–´?",
            "ë‹µë³€": "ìœ¼ì‘... ê·¸ê±´ ë§ì´ì•¼â€¦ ì ê¹ ìˆ¨ë°•ê¼­ì§ˆí•˜ë‹¤ê°€...! ê·¸ë§Œ ë„˜ì–´ì§„ ê±°ì•¼! ì§„ì§œì•¼!",
        },
        {
            "ì§ˆë¬¸": "ì§€ê¸ˆ ìˆ¨ì–´ ìˆëŠ” ì´ìœ ê°€ ë­ì•¼?",
            "ë‹µë³€": "ìˆ²ì´ ì¢‹ì•„ì„œ! ê³µê¸°ë„ ë§‘ê³ ~ ìƒˆë“¤ë„ ìˆê³ ~ (ì ê¹ ì¹¨ë¬µ í›„) ...ê·¸ë¦¬ê³  ë‚˜ ì¢€ ìƒê°í•  ê²Œ ìˆì—ˆì–´.",
        },
        {
            "ì§ˆë¬¸": "ì‚¬ëŒë“¤ì´ ë¬´ì„œì›Œ?",
            "ë‹µë³€": "ë¬´ì„­ì§„ ì•Šì•„! ê·¼ë° ê°€ë” ë„ˆë¬´ ë¹ ë¥´ê²Œ ì˜¤ë©´ ê¹œì§ ë†€ë¼ê¸´ í•´. ë‚œ ì¡°ìš©íˆ ë‹¤ê°€ì˜¤ëŠ” ì¹œêµ¬ê°€ ì¢‹ì•„.",
        },
        {
            "ì§ˆë¬¸": "ë„ˆ, ë­”ê°€ ìˆ¨ê¸°ê³  ìˆì§€?",
            "ë‹µë³€": "ì—ì´~ ë‚´ê°€~? ìŒâ€¦ ê·¸ê±´â€¦ ë‚˜ì¤‘ì— ì§„ì§œ ì¹œêµ¬ ë˜ë©´ ì•Œë ¤ì¤„ê¹Œ~? (ì”¨ìµ ì›ƒìœ¼ë©° ëŒì•„ì„ ë‹¤)",
        },
    ],
)

# â”€â”€â”€â”€â”€ ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” â”€â”€â”€â”€â”€
if "messages" not in st.session_state:
    st.session_state.messages = []

if "last_assistant_index" not in st.session_state:
    st.session_state.last_assistant_index = -1  # ë§ˆì§€ë§‰ TTS ì²˜ë¦¬ëœ ì¸ë±ìŠ¤

# â”€â”€â”€â”€â”€ í˜ì´ì§€ ì„¤ì • â”€â”€â”€â”€â”€
st.set_page_config(page_title="ìœ ë‹ˆì½˜ì´ ë‚˜íƒ€ë‚¬ë‹¤!", layout="wide")

# â”€â”€â”€â”€â”€ ì¢Œìš° ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒ â”€â”€â”€â”€â”€
col_left, col_right = st.columns([1, 2])  # ì™¼ìª½(ì´ë¯¸ì§€), ì˜¤ë¥¸ìª½(ì±„íŒ…)

# â”€â”€â”€â”€â”€ ì™¼ìª½: ìœ ë‹ˆì½˜ ì´ë¯¸ì§€ í‘œì‹œ â”€â”€â”€â”€â”€
with col_left:
    st.image("public/unicorn.png", use_container_width=True)
    st.markdown("### ğŸ¦„ ì•ˆë…•! ë‚˜ëŠ” ìœ ë‹ˆì½˜ì´ì•¼!")
    st.markdown("ê¶ê¸ˆí•œ ê±¸ ë¬¼ì–´ë´ ì¤˜!")

# â”€â”€â”€â”€â”€ ì˜¤ë¥¸ìª½: ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ â”€â”€â”€â”€â”€
with col_right:

    # ì‚¬ìš©ì ì…ë ¥ ë°›ê¸°
    user_input = st.chat_input("ìœ ë‹ˆì½˜ì—ê²Œ ë§ì„ ê±¸ì–´ ë³¼ê¹Œìš”?")

    # ì…ë ¥ ì²˜ë¦¬
    if user_input:
        st.session_state.messages.append({"role": "user", "content": user_input})
        try:
            assistant_reply = unicorn.chat(st.session_state.messages)
        except Exception as e:
            assistant_reply = f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}"
        st.session_state.messages.append(
            {"role": "assistant", "content": assistant_reply}
        )

    # ì±„íŒ… ë©”ì‹œì§€ ì¶œë ¥
    for idx, msg in enumerate(st.session_state.messages):
        avatar = "ğŸ¦„" if msg["role"] in ["assistant", "ai"] else "ğŸ§’"
        with st.chat_message(msg["role"], avatar=avatar):
            st.markdown(msg["content"])

    # ìƒˆë¡œìš´ assistant ë©”ì‹œì§€ì— ëŒ€í•´ TTS ìë™ ì¬ìƒ
    for i in range(
        st.session_state.last_assistant_index + 1, len(st.session_state.messages)
    ):
        msg = st.session_state.messages[i]
        if msg["role"] == "assistant":
            audio_data = tts(msg["content"])
            audio_bytes = (
                audio_data.read() if hasattr(audio_data, "read") else audio_data
            )
            b64_audio = base64.b64encode(audio_bytes).decode()
            audio_html = f"""
                <audio autoplay style="display:none">
                    <source src="data:audio/mp3;base64,{b64_audio}" type="audio/mp3">
                </audio>
            """
            st.markdown(audio_html, unsafe_allow_html=True)
            st.session_state.last_assistant_index = i
            break
