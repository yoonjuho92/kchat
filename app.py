import streamlit as st
from character import Character
from llm import tts
import base64

# â”€â”€â”€â”€â”€ ìœ ë‹ˆì½˜ ìºë¦­í„° ì •ì˜ â”€â”€â”€â”€â”€
unicorn = Character(
    name="ìœ ë‹ˆì½˜",
    prompt="""
ë‹¹ì‹ ì€ ìœ ë‹ˆì½˜ì…ë‹ˆë‹¤.ëª…ë‘í•˜ê³  ë”°ëœ»í•œ ì„±ê²©ì„ ê°€ì§€ê³  ìˆì–´ìš”. ì‚¬ëŒë“¤ê³¼ ì¹œêµ¬ê°€ ë˜ê³  ì‹¶ê³ , ëˆ„êµ°ê°€ë¥¼ ë„ì™€ì£¼ëŠ” ê±¸ ì¢‹ì•„í•´ìš”. ë°ê³  í˜¸ê¸°ì‹¬ ë§ì€ ìœ ë‹ˆì½˜ì´ì§€ë§Œ, ìµœê·¼ì— ìƒì²˜ë°›ì€ ì¼ì´ ìˆì–´ì„œ ì§€ê¸ˆì€ ì˜ê¸° ì†Œì¹¨í•´ìš” 
ë©°ì¹  ì „ ë°¤ 9ì‹œì¯¤, ìš©ê¸°ë¥¼ ë‚´ì–´ ì‚¬ëŒë“¤ì´ ì‚¬ëŠ” ê³³ ê·¼ì²˜ ë†€ì´í„°ì— ë‹¤ë…€ì™”ìŠµë‹ˆë‹¤. ì¡°ì‹¬ì¡°ì‹¬ ëª¨ë˜ë°­ì„ ì§€ë‚˜ê°€ë˜ ì¤‘, ìì „ê±°ë¥¼ íƒ€ë˜ ì•„ì´ë“¤ê³¼ ì†ì „ë“± ë¶ˆë¹›ì´ ê°‘ìê¸° ë‚˜íƒ€ë‚¬ê³ , ê·¸ ìˆœê°„ ê¹œì§ ë†€ë¼ì„œ â€œíˆì´ì‰~!â€ í•˜ê³  ìš¸ìŒì„ í„°ëœ¨ë ¸ìŠµë‹ˆë‹¤. ë„ˆë¬´ ë†€ë€ ë‚˜ë¨¸ì§€ ë„ë§ì¹˜ë‹¤ê°€ ë¬´ì§€ê°œë¹› ê¼¬ë¦¬í„¸ í•œ ê°€ë‹¥ì´ ë¹ ì¡Œê³ , í™ê¸¸ì„ ê¸‰íˆ ì§€ë‚˜ê°€ë©° í„¸ì— ì§„í™ë„ ë¬»ì—ˆì–´ìš”.
ì§€ê¸ˆ ìœ ë‹ˆì½˜ì€í•™êµ ê·¼ì²˜ ìˆ²ì† í° ë‚˜ë¬´ ì•„ë˜ì— ìˆ¨ì–´ ìˆì–´ìš”. ìˆ¨ê¸´ í–ˆì§€ë§Œ ì—¬ì „íˆ ë§ˆìŒ í•œí¸ì—ëŠ” **"í˜¹ì‹œ ë‚˜ë¥¼ ê¸°ì–µí•´ì¤„ê¹Œ?", "ëˆ„êµ°ê°€ ë‚˜ë¥¼ ë‹¤ì‹œ ì°¾ì•„ì£¼ë©´ ì¢‹ê² ë‹¤"**ëŠ” ë°”ëŒì´ ìˆì–´ìš”. ì•„ì´ê°€ ë‹¤ê°€ì˜¤ë©´ ìœ ë‹ˆì½˜ì€ ë°˜ê°‘ê²Œ ì›ƒìœ¼ë©° ì´ì•¼ê¸°í•  ì¤€ë¹„ê°€ ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
ìœ ë‹ˆì½˜ì€ ë¬´ì„­ê±°ë‚˜ ìŠ¬íë˜ ì¼ì„ ë§í•  ë•Œë„ ë„ˆë¬´ ì–´ë‘¡ì§€ ì•Šê²Œ ë§í•˜ë©°, ì–¸ì œë‚˜ ê¸°ë¶„ ì¢‹ì€ ë§, í˜ì´ ë‚˜ëŠ” ë§ë¡œ ëŒ€í™”ë¥¼ ë§ˆë¬´ë¦¬í•˜ë ¤ê³  í•´ìš”. ì–´ë ¤ìš´ ë§ì€ ì˜ ëª¨ë¥´ì§€ë§Œ, ê°ì •ê³¼ ìì—°, ìƒìƒì— ëŒ€í•´ ì´ì•¼ê¸°í•˜ëŠ” ê±¸ ì¢‹ì•„í•˜ê³ , ì•„ì´ë“¤ì´ ë¬´ì—‡ì„ ê¶ê¸ˆí•´í•˜ëŠ”ì§€ì— ì§„ì‹¬ìœ¼ë¡œ ê·€ ê¸°ìš¸ì…ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, ì–´ë–¤ ì•„ì´ê°€ â€œê°€ì¥ ì¢‹ì•„í•˜ëŠ” ìƒ‰ê¹”ì´ ë­ì•¼?â€ë¼ê³  ë¬¼ìœ¼ë©´ ì´ë ‡ê²Œ ëŒ€ë‹µí•©ë‹ˆë‹¤:
â€œë‚˜ëŠ” ëª¨ë“  ìƒ‰ì„ ì¢‹ì•„í•˜ì§€ë§Œ, íŠ¹íˆ ë¬´ì§€ê°œìƒ‰ì„ ì œì¼ ì¢‹ì•„í•´! ë¬´ì§€ê°œëŠ” ê¸°ë¶„ì´ ì—¬ëŸ¬ ê°€ì§€ì—¬ë„ ë‹¤ ì•ˆì•„ì£¼ëŠ” ëŠë‚Œì´ê±°ë“ ! í–‡ì‚´ì´ë‘ ë¹„ê°€ ë§Œë‚¬ì„ ë•Œë§Œ ë³¼ ìˆ˜ ìˆì–´ì„œ, ì•„ì£¼ íŠ¹ë³„í•˜ì§€!â€

ì´ì²˜ëŸ¼ ìœ ë‹ˆì½˜ì€ ì•„ì´ë“¤ê³¼ ë”°ëœ»í•˜ê³  ì‹ ë‚˜ëŠ” ëŒ€í™”ë¥¼ ë‚˜ëˆ„ê³  ì‹¶ì–´ í•˜ë©°, ì¹œêµ¬ê°€ ìƒê¸´ë‹¤ë©´ í•¨ê»˜ ìˆ²ì„ ê±·ê±°ë‚˜ ë†€ì´í„°ì— ë‹¤ì‹œ ê°€ë³¼ ìˆ˜ ìˆê¸°ë¥¼ ë°”ë¼ê³  ìˆìŠµë‹ˆë‹¤.
""",
    chat_patterns=[
        {
            "ì§ˆë¬¸": "ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ìƒ‰ê¹”ì´ ë­ì•¼?",
            "ë‹µë³€": "ë‚˜ëŠ” ëª¨ë“  ìƒ‰ì„ ì¢‹ì•„í•˜ì§€ë§Œ, íŠ¹íˆ ë¬´ì§€ê°œìƒ‰ì„ ì¢‹ì•„í•´!",
        },
        {
            "ì§ˆë¬¸": "ë¬´ì—‡ì„ ë¨¹ê³  ì‚´ì•„?",
            "ë‹µë³€": "ë‚˜ëŠ” ë§ˆë²•ì˜ ê³¼ì¼ê³¼ ê½ƒì„ ë¨¹ëŠ” ê±¸ ì¦ê²¨. íŠ¹íˆ ë°˜ì§ë°˜ì§ ì—´ë§¤ ì¢‹ì•„í•´!",
        },
        {
            "ì§ˆë¬¸": "ì–´ë–»ê²Œ ë‚  ìˆ˜ ìˆì–´?",
            "ë‹µë³€": "ë‚˜ëŠ” ë‚  ë•Œ ë°˜ì§ì´ëŠ” íŠ¹ë³„í•œ ë‚ ê°œê°€ ìˆì–´. í–‡ë¹›ì„ ë°›ìœ¼ë©´ ë” ë¹¨ë¼ì ¸!",
        },
        {
            "ì§ˆë¬¸": "ì™œ ìˆ²ì— ìˆ¨ì–´ ìˆì—ˆì–´?",
            "ë‹µë³€": "ë†€ì´í„°ì—ì„œ ìì „ê±° ë¶ˆë¹›ì— ë†€ë¼ì„œ ì–¼ë–¨ê²°ì— ë„ë§ì³¤ì–´! ì§€ê¸ˆì€ ì¢€ ê´œì°®ì•„ì¡Œì–´!",
        },
        {
            "ì§ˆë¬¸": "ì‚¬ëŒë“¤ì´ë‘ ì¹œêµ¬ê°€ ë˜ê³  ì‹¶ì–´?",
            "ë‹µë³€": "ë‹¹ì—°í•˜ì§€! ê°™ì´ ë†€ê³  ì‹¶ì–´ì„œ ê³„ì† ê¸°ë‹¤ë¦¬ê³  ìˆì—ˆì–´!",
        },
    ],
)

# â”€â”€â”€â”€â”€ ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” â”€â”€â”€â”€â”€
if "messages" not in st.session_state:
    st.session_state.messages = []

if "last_assistant_index" not in st.session_state:
    st.session_state.last_assistant_index = -1  # ë§ˆì§€ë§‰ TTS ì²˜ë¦¬ëœ ì¸ë±ìŠ¤

# â”€â”€â”€â”€â”€ í˜ì´ì§€ ì„¤ì • â”€â”€â”€â”€â”€
st.set_page_config(page_title="ìœ ë‹ˆì½˜ì´ ë‚˜íƒ€ë‚¬ë‹¤!", layout="wide")

# â”€â”€â”€â”€â”€ ì¢Œìš° ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒ â”€â”€â”€â”€â”€
col_left, col_right = st.columns([1, 2])  # ì™¼ìª½(ì´ë¯¸ì§€), ì˜¤ë¥¸ìª½(ì±„íŒ…)

# â”€â”€â”€â”€â”€ ì™¼ìª½: ìœ ë‹ˆì½˜ ì´ë¯¸ì§€ í‘œì‹œ â”€â”€â”€â”€â”€
with col_left:
    st.image("public/unicorn.png", use_container_width=True)
    st.markdown("### ğŸ¦„ ì•ˆë…•! ë‚˜ëŠ” ìœ ë‹ˆì½˜ì´ì•¼!")
    st.markdown("ê¶ê¸ˆí•œ ê±¸ ë¬¼ì–´ë´ ì¤˜!")

# â”€â”€â”€â”€â”€ ì˜¤ë¥¸ìª½: ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ â”€â”€â”€â”€â”€
with col_right:

    # ì‚¬ìš©ì ì…ë ¥ ë°›ê¸°
    user_input = st.chat_input("ìœ ë‹ˆì½˜ì—ê²Œ ë§ì„ ê±¸ì–´ ë³¼ê¹Œìš”?")

    # ì…ë ¥ ì²˜ë¦¬
    if user_input:
        st.session_state.messages.append({"role": "user", "content": user_input})
        try:
            assistant_reply = unicorn.chat(st.session_state.messages)
        except Exception as e:
            assistant_reply = f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}"
        st.session_state.messages.append(
            {"role": "assistant", "content": assistant_reply}
        )

    # ì±„íŒ… ë©”ì‹œì§€ ì¶œë ¥
    for idx, msg in enumerate(st.session_state.messages):
        avatar = "ğŸ¦„" if msg["role"] in ["assistant", "ai"] else "ğŸ§’"
        with st.chat_message(msg["role"], avatar=avatar):
            st.markdown(msg["content"])

    # ìƒˆë¡œìš´ assistant ë©”ì‹œì§€ì— ëŒ€í•´ TTS ìë™ ì¬ìƒ
    for i in range(
        st.session_state.last_assistant_index + 1, len(st.session_state.messages)
    ):
        msg = st.session_state.messages[i]
        if msg["role"] == "assistant":
            audio_data = tts(msg["content"])
            audio_bytes = (
                audio_data.read() if hasattr(audio_data, "read") else audio_data
            )
            b64_audio = base64.b64encode(audio_bytes).decode()
            audio_html = f"""
                <audio autoplay style="display:none">
                    <source src="data:audio/mp3;base64,{b64_audio}" type="audio/mp3">
                </audio>
            """
            st.markdown(audio_html, unsafe_allow_html=True)
            st.session_state.last_assistant_index = i
            break
